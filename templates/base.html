<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Gesti√≥n de Votantes{% endblock %}</title>
    
    <!-- ‚úÖ ANTI-CACH√â HEADERS PARA FORZAR RECARGA -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="{{ 1702512000 }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ‚úÖ INDICADOR ANTI-CACH√â -->
    <script>
        console.log('üì± VERSI√ìN LIMPIA: 2025-11-14-04-44');
        console.log('üö®üö®üö® SI VES ESTE MENSAJE, LA P√ÅGINA SE RECARG√ì CORRECTAMENTE');
    </script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link {
            color: white !important;
        }
        
        .navbar-custom .nav-link:hover {
            color: #ecf0f1 !important;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        /* Estilos para fotos clicables */
        .foto-votante-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid #dee2e6;
        }
        
        .foto-votante-thumbnail:hover {
            transform: scale(1.1);
            border-color: var(--secondary-color);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }
        
        /* Modal para fotos ampliadas */
        .modal-foto {
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .modal-foto img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        
        /* Bot√≥n GPS */
        .btn-gps {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .btn-gps:hover {
            background: #219a52;
            transform: scale(1.1);
        }
        
        .btn-gps.loading {
            background: #f39c12;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para marcador GPS temporal */
        .gps-marker-temp {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .btn-primary {
            background: var(--secondary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-card .label {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        #map {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .foto-votante {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .foto-votante-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if session.user_id %}
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-vote-yea me-2"></i>
                Sistema de Votantes
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if session.rol == 'candidato' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard_candidato') }}">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('buscar_votantes') }}">
                            <i class="fas fa-search me-1"></i>Buscar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('lista_colaboradores') }}">
                            <i class="fas fa-users me-1"></i>Colaboradores
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard_colaborador') }}">
                            <i class="fas fa-list me-1"></i>Mis Votantes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('buscar_votantes') }}">
                            <i class="fas fa-search me-1"></i>Buscar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('nuevo_votante') }}">
                            <i class="fas fa-plus-circle me-1"></i>Nuevo Votante
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>{{ session.nombre }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Modal para ver fotos ampliadas -->
    <div class="modal fade" id="modalFoto" tabindex="-1" aria-labelledby="modalFotoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-foto">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFotoLabel">
                        <i class="fas fa-camera me-2"></i>Foto del Votante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imagenAmpliada" src="" alt="Foto del votante" class="img-fluid">
                    <div id="infoFoto" class="mt-3">
                        <h6 id="nombreVotante"></h6>
                        <p id="cedulaVotante" class="text-muted"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- JavaScript para modal de fotos -->
    <script>
        // Funci√≥n para mostrar foto en modal
        function mostrarFoto(fotoSrc, nombre, cedula) {
            const modal = new bootstrap.Modal(document.getElementById('modalFoto'));
            const imagen = document.getElementById('imagenAmpliada');
            const nombreVotante = document.getElementById('nombreVotante');
            const cedulaVotante = document.getElementById('cedulaVotante');
            
            imagen.src = fotoSrc;
            nombreVotante.textContent = nombre;
            cedulaVotante.textContent = cedula ? `C√©dula: ${cedula}` : 'Sin n√∫mero de c√©dula';
            
            modal.show();
        }
        
        // Funci√≥n para geolocalizaci√≥n GPS - VERSI√ìN CORREGIDA CON DIAGN√ìSTICO
        // ‚úÖ ANTI-CACH√â: Variable para forzar recarga de JavaScript
        window.GPS_VERSION = '2025-11-14-04-03';
        
        // ‚úÖ ANTI-AUTO-GUARDADO: Flag global para bloquear guardados autom√°ticos
        window.GPS_AUTO_GUARDADO_BLOQUEADO = true;
        window.GPS_CONFIRMADO_POR_USUARIO = false;
        
        // ‚úÖ FUNCI√ìN GLOBAL: Hacer disponible desde formularios
        window.GPS_ORIGINAL = null;
        
        // ‚úÖ ALMACENAR FUNCI√ìN GPS ORIGINAL
        if (typeof window.obtenerUbicacionGPS === 'function') {
            window.GPS_ORIGINAL = window.obtenerUbicacionGPS;
        }
        
        function obtenerUbicacionGPS(latitudId, longitudId, mapId) {
            console.log('üìç GPS iniciado por usuario');
            const nombreField = document.getElementById('nombre');
            const latField = document.getElementById(latitudId);
            const lngField = document.getElementById(longitudId);
            
            console.log('üìä Estado del formulario:', {
                nombreValue: nombreField ? nombreField.value : 'NO_ENCONTRADO',
                latValue: latField ? latField.value : 'NO_ENCONTRADO', 
                lngValue: lngField ? lngField.value : 'NO_ENCONTRADO'
            });
            
            const btnGps = document.querySelector(`#${mapId}`).parentNode.querySelector('.btn-gps');
            
            if (!navigator.geolocation) {
                alert('‚ùå Tu navegador no soporta geolocalizaci√≥n');
                return;
            }
            
            // ‚úÖ Verificaci√≥n manual del usuario
            window.GPS_CONFIRMADO_POR_USUARIO = true;
            
            // Mostrar estado de carga
            btnGps.classList.add('loading');
            btnGps.innerHTML = '<i class="fas fa-spinner"></i>';
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutos
            };
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    console.log('üìç GPS obtenido:', lat.toFixed(6), ',', lng.toFixed(6));
                    
                    // ‚úÖ SOLO MOSTRAR EN MAPA - NO TOCAR CAMPOS HIDDEN
                    // Centrar mapa en la ubicaci√≥n GPS (solo visualizaci√≥n)
                    if (typeof window.mapas !== 'undefined' && window.mapas[mapId]) {
                        window.mapas[mapId].setView([lat, lng], 16);
                        
                        // Mostrar marcador temporal GPS (visualizaci√≥n √∫nicamente)
                        if (window.mapas[mapId].gpsMarker) {
                            window.mapas[mapId].removeLayer(window.mapas[mapId].gpsMarker);
                        }
                        
                        window.mapas[mapId].gpsMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'gps-marker-temp',
                                html: '<div style="background: #ff4444; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(window.mapas[mapId]).bindPopup('<b>üìç GPS Encontrado</b><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6) + '<br><small class="text-success">Haz clic en "Aceptar" para aplicar estas coordenadas</small>').openPopup();
                    }
                    
                    // Restaurar bot√≥n
                    btnGps.classList.remove('loading');
                    btnGps.innerHTML = '<i class="fas fa-crosshairs"></i>';
                    
                    // ‚úÖ CONFIRMACI√ìN OBLIGATORIA - SIN EXCEPCIONES
                    setTimeout(() => {
                        console.log('üîî MOSTRANDO VENTANA DE CONFIRMACI√ìN...');
                        const confirmado = confirm(`üìç Ubicaci√≥n GPS Obtenida:\n\nLatitud: ${lat.toFixed(6)}\nLongitud: ${lng.toFixed(6)}\n\n¬øDeseas usar esta ubicaci√≥n GPS?\n\n‚Ä¢ Aceptar = Aplicar coordenadas GPS\n‚Ä¢ Cancelar = Mantener ubicaci√≥n manual actual`);
                        
                        console.log(confirmado ? '‚úÖ GPS confirmado por usuario' : '‚ùå GPS cancelado por usuario');
                        
                        if (confirmado) {
                            aplicarCoordenadasGPS(lat, lng, latitudId, longitudId, mapId);
                        } else {
                            console.log('‚ùå GPS cancelado por el usuario');
                            // Reset flag
                            window.GPS_CONFIRMADO_POR_USUARIO = false;
                            
                            // Si cancela, limpiar el marcador temporal
                            if (typeof window.mapas !== 'undefined' && window.mapas[mapId] && window.mapas[mapId].gpsMarker) {
                                window.mapas[mapId].removeLayer(window.mapas[mapId].gpsMarker);
                            }
                            alert('‚ÑπÔ∏è GPS cancelado. Puedes hacer clic manualmente en el mapa para establecer la ubicaci√≥n.');
                        }
                    }, 1000); // 1 segundo de delay para que se vea el bot√≥n normal
                    
                },
                function(error) {
                    let mensaje = '‚ùå Error al obtener ubicaci√≥n GPS';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje = '‚ùå Permisos de ubicaci√≥n denegados. Por favor, permite el acceso a la ubicaci√≥n en tu navegador.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje = '‚ùå Informaci√≥n de ubicaci√≥n no disponible. Verifica que tengas GPS activado.';
                            break;
                        case error.TIMEOUT:
                            mensaje = '‚ùå Tiempo de espera agotado. Intenta de nuevo.';
                            break;
                    }
                    
                    console.log('‚ùå Error GPS:', mensaje);
                    alert(mensaje);
                    
                    // Restaurar bot√≥n
                    btnGps.classList.remove('loading');
                    btnGps.innerHTML = '<i class="fas fa-crosshairs"></i>';
                    window.GPS_CONFIRMADO_POR_USUARIO = false;
                },
                options
            );
        }
        
        // ‚úÖ NUEVA FUNCI√ìN SIMPLIFICADA PARA APLICAR GPS
        function aplicarCoordenadasGPS(lat, lng, latitudId, longitudId, mapId) {
            // üö® ALERTA CR√çTICA: Esta funci√≥n SOLO debe llamarse tras confirmaci√≥n
            console.log('üìç Aplicando coordenadas GPS');
            
            // ‚úÖ VALIDACI√ìN CR√çTICA: Solo permitir si viene del flujo confirmado
            if (!window.GPS_CONFIRMADO_POR_USUARIO) {
                console.error('üö®üö®üö® ALERTA: aplicarCoordenadasGPS llamado SIN confirmaci√≥n del usuario!');
                console.error('üö®üö®üö® ESTO ES UN PROBLEMA - Bloqueando actualizaci√≥n');
                alert('üö® Error: GPS no puede aplicarse sin confirmaci√≥n del usuario');
                return;
            }
            
            if (!window.GPS_AUTO_GUARDADO_BLOQUEADO) {
                console.error('üö®üö®üö® ALERTA: Auto-guardado no est√° bloqueado!');
                console.error('üö®üö®üö® ESTO ES UN PROBLEMA - Bloqueando actualizaci√≥n');
                alert('üö® Error: Sistema anti-auto-guardado no activado');
                return;
            }
            
            console.log('‚úÖ Validaciones pasadas - Aplicando coordenadas');
            
            // ‚úÖ ACTUALIZAR CAMPOS HIDDEN SOLO AQU√ç
            const latField = document.getElementById(latitudId);
            const lngField = document.getElementById(longitudId);
            
            if (latField && lngField) {
                const oldLat = latField.value;
                const oldLng = lngField.value;
                
                latField.value = lat.toFixed(6);
                lngField.value = lng.toFixed(6);
                
                console.log('‚úÖ Campos hidden actualizados:', {
                    antes: { lat: oldLat, lng: oldLng },
                    despues: { lat: latField.value, lng: lngField.value }
                });
            } else {
                console.error('‚ùå No se encontraron campos hidden:', latitudId, longitudId);
                alert('‚ùå Error: No se pudieron actualizar las coordenadas GPS');
                return;
            }
            
            // ‚úÖ ACTUALIZAR MAPA
            if (typeof window.mapas !== 'undefined' && window.mapas[mapId]) {
                // Remover marcador temporal GPS
                if (window.mapas[mapId].gpsMarker) {
                    window.mapas[mapId].removeLayer(window.mapas[mapId].gpsMarker);
                    console.log('üóëÔ∏è Marcador temporal GPS removido');
                }
                
                // Crear marcador permanente
                if (window.mapas[mapId].marker) {
                    window.mapas[mapId].removeLayer(window.mapas[mapId].marker);
                }
                
                window.mapas[mapId].marker = L.marker([lat, lng]).addTo(window.mapas[mapId]);
                window.mapas[mapId].marker.bindPopup('<b>‚úÖ GPS Aplicado</b><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6)).openPopup();
                console.log('‚úÖ Marcador GPS permanente creado en el mapa');
            }
            
            // ‚úÖ MOSTRAR MENSAJE DE √âXITO
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 m-3 bg-success text-white p-3 rounded';
            toast.style.zIndex = '9999';
            toast.innerHTML = '<i class="fas fa-check me-2"></i>‚úÖ Ubicaci√≥n GPS aplicada correctamente<br><small>Solo tras tu confirmaci√≥n</small>';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
            
            // ‚úÖ Reset flag despu√©s de aplicar
            window.GPS_CONFIRMADO_POR_USUARIO = false;
            
            console.log('‚úÖ GPS aplicado exitosamente');
        }
        
        // ‚úÖ BLOQUEADOR DE EVENTOS: Prevenir guardado autom√°tico
        document.addEventListener('DOMContentLoaded', function() {
            // ‚úÖ Protecci√≥n GPS activada
            const formularios = document.querySelectorAll('form');
            formularios.forEach(formulario => {
                
                // üõ°Ô∏è BLOQUEAR submits autom√°ticos de validaci√≥n HTML5
                formulario.addEventListener('submit', function(e) {
                    // Verificar si es un submit autom√°tico o manual
                    const submitButton = e.submitter;
                    const botonGuardar = formulario.querySelector('button[type="submit"]');
                    
                    if (submitButton && botonGuardar && submitButton === botonGuardar) {
                        console.log('‚úÖ Formulario de guardado detectado - Permitiendo env√≠o');
                    } else {
                        console.log('üö´ Bloqueando submit autom√°tico de validaci√≥n HTML5');
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                });
                
                // üõ°Ô∏è Intervenir validaci√≥n de campos requeridos
                formulario.addEventListener('input', function(e) {
                    if (e.target.hasAttribute('required')) {
                        // Validaci√≥n silenciosa - sin mensajes de consola
                        setTimeout(() => {
                            if (formulario.checkValidity()) {
                                // Formulario v√°lido pero no se env√≠a autom√°ticamente
                            }
                        }, 100);
                    }
                });
            });
            
            // ‚úÖ Banner visual removido por solicitud del usuario
            
            // Sistema GPS activado silenciosamente
        });
        
        // Funci√≥n para crear bot√≥n GPS en mapas
        function agregarBotonGPS(mapId, latitudId, longitudId) {
            const mapContainer = document.querySelector(`#${mapId}`).parentNode;
            
            const btnGps = document.createElement('button');
            btnGps.className = 'btn btn-gps';
            btnGps.innerHTML = '<i class="fas fa-crosshairs"></i>';
            btnGps.title = 'üìç Obtener mi ubicaci√≥n GPS (pedir√° confirmaci√≥n)';
            btnGps.style.cssText = 'position: absolute; top: 10px; right: 10px; z-index: 1000; background: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px;';
            
            // ‚úÖ CR√çTICO: Evitar propagaci√≥n al mapa
            btnGps.addEventListener('click', function(e) {
                console.log('üìç BOT√ìN GPS CLICKEADO - EVENT STOP PROPAGATION');
                e.stopPropagation(); // ‚ùå EVITA que el click llegue al mapa
                obtenerUbicacionGPS(latitudId, longitudId, mapId);
            });
            
            // Tambi√©n mantener el onclick como fallback
            btnGps.onclick = function(e) {
                console.log('üìç BOT√ìN GPS CLICKEADO (onclick fallback)');
                e.stopPropagation();
                obtenerUbicacionGPS(latitudId, longitudId, mapId);
            };
            
            mapContainer.style.position = 'relative';
            mapContainer.appendChild(btnGps);
            
            // Bot√≥n GPS creado
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
