{% extends "base.html" %}

{% block title %}Editar Votante{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="fas fa-user-edit me-2"></i>Editar Votante</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Datos del Votante</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="foto_actual" value="{{ votante.foto or '' }}">
                    
                    <div class="mb-3">
                        <label for="nombre_completo" class="form-label">
                            <i class="fas fa-user me-2"></i>Nombre Completo *
                        </label>
                        <input type="text" class="form-control" id="nombre_completo" 
                               name="nombre_completo" value="{{ votante.nombre_completo }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="numero_cedula" class="form-label">
                            <i class="fas fa-id-card me-2"></i>N√∫mero de C√©dula
                        </label>
                        <input type="text" class="form-control" id="numero_cedula" 
                               name="numero_cedula" value="{{ votante.numero_cedula or '' }}" 
                               required onchange="validarCedulaUnica()">
                        <div id="cedula-validation" class="mt-1"></div>
                        <small class="text-muted">N√∫mero de c√©dula de identidad del votante (√∫nico)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">
                                <i class="fas fa-phone me-2"></i>Tel√©fono
                            </label>
                            <input type="tel" class="form-control" id="telefono" name="telefono"
                                   value="{{ votante.telefono or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="escuela_votacion" class="form-label">
                                <i class="fas fa-school me-2"></i>Escuela de Votaci√≥n
                            </label>
                            <input type="text" class="form-control" id="escuela_votacion" 
                                   name="escuela_votacion" value="{{ votante.escuela_votacion or '' }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="direccion" class="form-label">
                            <i class="fas fa-map-marker-alt me-2"></i>Direcci√≥n
                        </label>
                        <input type="text" class="form-control" id="direccion" name="direccion"
                               value="{{ votante.direccion or '' }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-map-marked-alt me-2"></i>Ubicaci√≥n en el Mapa
                        </label>
                        <div id="map" style="height: 400px; border-radius: 10px; position: relative;"></div>
                        <small class="text-muted">
                            <i class="fas fa-crosshairs me-1"></i>Usa el bot√≥n GPS <i class="fas fa-crosshairs me-1"></i> para obtener tu ubicaci√≥n autom√°ticamente, o haz clic en el mapa para actualizarla manualmente
                        </small>
                        <input type="hidden" id="latitud" name="latitud" 
                               value="{{ votante.latitud or '' }}">
                        <input type="hidden" id="longitud" name="longitud"
                               value="{{ votante.longitud or '' }}">
                    </div>

                    <div class="mb-3">
                        <label for="foto" class="form-label">
                            <i class="fas fa-camera me-2"></i>Foto del Votante
                        </label>
                        {% if votante.foto %}
                        <div class="mb-2">
                            <img src="{{ url_for('uploaded_file', filename=votante.foto) }}" 
                                 alt="Foto actual" class="foto-votante">
                            <p class="text-muted small mt-1">Foto actual</p>
                        </div>
                        {% endif %}
                        <input type="file" class="form-control" id="foto" name="foto" 
                               accept="image/*">
                        <small class="text-muted">Deja vac√≠o para mantener la foto actual</small>
                    </div>

                    <div class="mb-3">
                        <label for="notas" class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>Notas Adicionales
                        </label>
                        <textarea class="form-control" id="notas" name="notas" 
                                  rows="3">{{ votante.notas or '' }}</textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard_colaborador') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Actualizar Votante
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informaci√≥n</h5>
            </div>
            <div class="card-body">
                <p><strong>Datos del registro:</strong></p>
                <ul>
                    <li><strong>ID:</strong> {{ votante.id }}</li>
                    <li><strong>Registrado:</strong> {{ votante.fecha_registro[:10] }}</li>
                </ul>
                <hr>
                <p><strong>Para actualizar la ubicaci√≥n:</strong></p>
                <ul>
                    <li>Hacer clic en el mapa (manual)</li>
                    <li>Usar el bot√≥n GPS (üìç) para auto-detectar</li>
                </ul>
                <hr>
                <p class="text-muted mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    <small>Actualiza la informaci√≥n del votante seg√∫n sea necesario</small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Coordenadas existentes o por defecto
    let lat = {{ votante.latitud if votante.latitud else -25.2637 }};
    let lng = {{ votante.longitud if votante.longitud else -57.5759 }};
    
    const map = L.map('map').setView([lat, lng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Almacenar referencia global al mapa
    window.mapas = window.mapas || {};
    window.mapas['map'] = map;
    
    // A√±adir marcador si ya existe ubicaci√≥n
    let marker = null;
    let bloqueandoGPS = false; // ‚úÖ Flag para evitar conflictos GPS
    
    {% if votante.latitud and votante.longitud %}
    marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup('<b>Ubicaci√≥n actual</b><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6)).openPopup();
    {% endif %}
    
    // Manejar clic en el mapa (edici√≥n manual)
    map.on('click', function(e) {
        // ‚úÖ ANTICONFLICTO: Verificar si GPS est√° activo
        if (bloqueandoGPS) {
            console.log('üö´ Click en mapa IGNORADO - GPS activo');
            return;
        }
        
        lat = e.latlng.lat;
        lng = e.latlng.lng;
        
        // Actualizar campos ocultos
        document.getElementById('latitud').value = lat.toFixed(6);
        document.getElementById('longitud').value = lng.toFixed(6);
        
        // Eliminar marcador anterior si existe
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Crear nuevo marcador
        marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup('<b>Nueva ubicaci√≥n</b><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6)).openPopup();
        console.log('‚úÖ Click manual en mapa ejecutado');
    });
    
    // ‚úÖ ANTICONFLICTO GPS: Override funci√≥n GPS para activar flag
    const originalObtenerUbicacionGPS = window.obtenerUbicacionGPS;
    window.obtenerUbicacionGPS = function(latitudId, longitudId, mapId) {
        console.log('üö´ ACTIVANDO BLOQUEO ANTI-CONFLICTO GPS');
        bloqueandoGPS = true;
        
        // Ejecutar funci√≥n GPS original
        originalObtenerUbicacionGPS.call(this, latitudId, longitudId, mapId);
        
        // Resetear flag despu√©s del proceso GPS
        setTimeout(() => {
            bloqueandoGPS = false;
            console.log('‚úÖ BLOQUEO ANTI-CONFLICTO GPS DESACTIVADO');
        }, 5000);
    };
    
    // Agregar bot√≥n GPS al mapa
    agregarBotonGPS('map', 'latitud', 'longitud');

    // Validaci√≥n de c√©dula √∫nica en tiempo real
    let cedulaTimeout;
    function validarCedulaUnica() {
        const cedulaInput = document.getElementById('numero_cedula');
        const validationDiv = document.getElementById('cedula-validation');
        const cedula = cedulaInput.value.trim();
        const votanteId = {{ votante.id if votante else 'null' }};
        
        // Limpiar timeout anterior
        clearTimeout(cedulaTimeout);
        
        if (!cedula) {
            validationDiv.innerHTML = '';
            return;
        }
        
        // Validaci√≥n visual inmediata
        cedulaInput.classList.remove('is-valid', 'is-invalid');
        
        // Mostrar indicador de carga
        validationDiv.innerHTML = '<small><i class="fas fa-spinner fa-spin me-1"></i>Verificando...</small>';
        
        // Esperar 500ms antes de validar para evitar muchas consultas
        cedulaTimeout = setTimeout(() => {
            const url = votanteId 
                ? `/validar/cedula/${encodeURIComponent(cedula)}?votante_id=${votanteId}`
                : `/validar/cedula/${encodeURIComponent(cedula)}`;
                
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    validationDiv.innerHTML = '';
                    
                    if (data.valida) {
                        cedulaInput.classList.add('is-valid');
                        validationDiv.innerHTML = `<small class="text-success"><i class="fas fa-check me-1"></i>${data.mensaje}</small>`;
                    } else {
                        cedulaInput.classList.add('is-invalid');
                        validationDiv.innerHTML = `<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${data.mensaje}</small>`;
                    }
                })
                .catch(error => {
                    console.error('Error validando c√©dula:', error);
                    validationDiv.innerHTML = '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Error al validar</small>';
                });
        }, 500);
    }
    
    // Validar c√©dula al cargar la p√°gina si ya existe una
    document.addEventListener('DOMContentLoaded', function() {
        const cedulaValue = document.getElementById('numero_cedula').value;
        if (cedulaValue) {
            setTimeout(() => validarCedulaUnica(), 1000); // Dar tiempo para que la p√°gina se cargue
        }
    });
</script>
{% endblock %}
